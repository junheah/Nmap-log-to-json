<meta charset="utf-8">
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="data.js" ></script>
        <script>
            var existingPorts = [];
            var isShowZeroPorts = false;
            //TODO: MAKE THIS WORK
            function createTd(text){
                var td = document.createElement("td");
                td.innerHTML = text;
                return td;
            }

            function createTh(text){
                var th = document.createElement("th");
                th.innerHTML = text;
                return th;
            }

            function getStatusStr(code){
                switch(code){
                    case 0:
                    return 'down';
                    case 1:
                    return 'up';
                    case 2:
                    return 'filtered';
                }
            }

            function expand(i){
                var div = document.getElementById(i);
                if (div.style.display === "block") {
                    div.style.display = "none";
                } else {
                    div.style.display = "block";
                }
            }

            function createTable(ports){
                var selection = document.getElementById('filter_selection').options[document.getElementById('filter_selection').selectedIndex].value
                var filter_contents = document.getElementById('filter').value
                var table = document.createElement("table");
                var thead = document.createElement("thead");
                var tr = document.createElement("tr");
                if(ports != null){
                    for(key in ports[0]){
                        tr.appendChild(createTh(key))
                    }
                }else{
                    tr.appendChild(createTh("There is no ports"));
                    thead.appendChild(tr);
                    table.appendChild(thead);
                    return table;
                }
                thead.appendChild(tr);
                table.appendChild(thead);
                var tbody = document.createElement("tbody");
                var isAdded = false;
                try{
                    for(var i=0; i< ports.length; i++){
                        var port = ports[i];
                        var row = document.createElement('tr');
                        for (key in port){
                            if(filter_contents != '' && key == 'portNo' && selection == 'port'){
                                if(port[key] != filter_contents){
                                    break;
                                }else{
                                    row.appendChild(createTd(port[key]));
                                    isAdded = true;
                                }
                            }else if(filter_contents != '' && key == 'service' && selection == 'service'){
                                if(port[key].search(filter_contents) == -1) {
                                    row = document.createElement('tr');
                                    isAdded = false
                                    break;
                                }
                                else{
                                    row.appendChild(createTd(port[key]));
                                    isAdded = true;
                                }
                            }else{
                                row.appendChild(createTd(port[key]));
                                isAdded = true;
                            }
                        }
                        if(row.childNodes.length != 0){
                            tbody.appendChild(row);
                        }
                    }
                }catch(e){}
                if(!isAdded)   return false; 
                table.appendChild(tbody);
                return table;
            }

            function reload(){
                var hideZero = isShowZeroPorts;
                var container = document.getElementById("container");
                //clear container
                container.innerHTML="";
                var count = 0;
                for(var i=0; i<data.length; i++){
                    var d = data[i];
                    if(hideZero){
                        //continue if scanned_ports == null
                        try{
                            if(d.scannedPorts.length == 0) continue; //throws exception if null
                        }catch(e){continue;}
                    }
                    // count++;
                    var row = document.createElement("tr");
                    var tmp_table =createTable(d.scannedPorts);
                    if(tmp_table == false) continue;
                    row.appendChild(createTd(d.host));
                    row.appendChild(createTd(getStatusStr(d.status)));
                    row.appendChild(createTd(d.scannedPorts != null ? d.scannedPorts.length : 0));
                    row.setAttribute("onClick","expand("+i+");");
                    row.className = "host";
                    container.appendChild(row);

                    var divRow = document.createElement("tr");
                    var td = document.createElement("td");
                    td.setAttribute("colspan",3);
                    var collapsible = document.createElement('div');
                    collapsible.className = 'ports';
                    collapsible.id = i;
                    collapsible.appendChild(tmp_table);
                    td.append(collapsible);
                    divRow.append(td);
                    container.appendChild(divRow);
                }
                count = document.getElementById('container').children.length/2;
                document.getElementById("title").innerHTML = count.toString() + '/' + data.length + " 개";
            }
            
            function changeHideZero(hideZero){
                isShowZeroPorts = hideZero;
                reload();
            }
        </script>
        <style>
            table{
                text-align: left;
                width: 100%;
                border-collapse: collapse;
            }

            div.ports{
                display: none;
                margin:10px;
                background:#fea;
            }
            tr.host:hover{
                background: #ddd;
            }
            tr.host{
                background:white;
                padding:20px;
            }
            table, th, td{
                border-bottom: 1px solid #ddd;
                padding: 5px;
                min-height: 0;
            }
            th{
                width:10%;
            }
            div#header{

                background-color: #eee;
                position: fixed;
                top: 0;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div id='header'>
            <h2>호스트 (Up,Filtered):</h2>
            <h2 id="title"></h2>
            <button onclick="changeHideZero(true);">포트 0 숨기기</button>
            <button onclick="changeHideZero(false);">포트 0 보이기</button>
            <select id="filter_selection">
                <option value="port">Port</option>
                <option value="service">Service</option>
            </select>
            <input type="text" id="filter">
            <button onclick="changeHideZero(true);reload()">검색</button>
            <table>
                <thead>
                    <tr>
                        <th>host</th>
                        <th>status</th>
                        <th>ports</th>
                    </tr>
                </thead>
            </table>
        </div>
        <div style="margin-top:200px;">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="container">
                </tbody>
            </table>
        </div>


        <script>
            reload();
        </script>
    </body>
</html>
